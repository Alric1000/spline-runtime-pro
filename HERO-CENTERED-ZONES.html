<!-- HERO SCENE - CENTERED ZONES VERSION -->
<!-- Adjustable scene boundaries for accurate touch mapping -->

<script>
(function() {
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';
    const HERO_SCENE = 'hero-animation';
    const dpr = window.devicePixelRatio || 1;

    console.log('[HERO-CENTERED] Starting with adjustable touch zones');

    let viewer = null;
    let splineApp = null;
    let skiObjects = [];
    let isInteracting = false;
    let currentSki = null;
    let startX = 0;
    let startRotation = 0;
    let animationFrame = null;

    // Scene boundaries (adjustable)
    // These define where the actual skis are within the canvas
    // 0.2 means scene starts at 20% from left, 0.8 means ends at 80%
    let SCENE_LEFT_BOUNDARY = 0.25;   // Adjust if skis start further right
    let SCENE_RIGHT_BOUNDARY = 0.75;  // Adjust if skis end further left

    // DEFAULT ROTATION IS 90 DEGREES
    const DEFAULT_ROTATION = 90;
    const DEFAULT_RADIANS = DEFAULT_ROTATION * (Math.PI / 180);

    // Current rotations
    let currentRotations = [DEFAULT_ROTATION, DEFAULT_ROTATION, DEFAULT_ROTATION, DEFAULT_ROTATION];

    // Ski mapping
    const SKI_MAPPING = [
        { name: 'CARVE', uuid: 'c5d6f3ff-e0a8-42e3-8fa3-3ab4f6a6a82c', position: 0 },
        { name: 'PARK', uuid: '731fbf35-4ab6-40a4-b7d0-22cd41b67649', position: 1 },
        { name: 'ALLMOUNTAIN', uuid: '1057c6ec-57c0-4d4a-bdd0-00999322dd99', position: 2 },
        { name: 'POWDER', uuid: '7bf4341d-f8b6-4b99-9ceb-f60a8670aad0', position: 3 }
    ];

    // Create viewer
    function createViewer() {
        const container = document.querySelector('.spline-container') ||
                         document.getElementById('hero-container');

        if (!container) {
            console.error('[HERO-CENTERED] No container found');
            return;
        }

        viewer = document.createElement('spline-viewer');
        viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${HERO_SCENE}/scene.splinecode`);
        viewer.style.width = '100%';
        viewer.style.height = '100%';
        viewer.style.display = 'block';

        container.appendChild(viewer);
        console.log('[HERO-CENTERED] Viewer created');

        setTimeout(initializeScene, 2000);
    }

    // Initialize scene
    function initializeScene() {
        splineApp = viewer._spline;

        if (!splineApp) {
            console.log('[HERO-CENTERED] App not ready, retrying...');
            setTimeout(initializeScene, 500);
            return;
        }

        console.log('[HERO-CENTERED] App found! Setting up skis...');

        if (splineApp.getAllObjects) {
            const allObjects = splineApp.getAllObjects();

            SKI_MAPPING.forEach((ski, index) => {
                const obj = allObjects.find(o => o.uuid === ski.uuid);
                if (obj) {
                    skiObjects[index] = obj;
                    console.log(`[HERO-CENTERED] ${ski.name} ready`);

                    // Set initial rotation
                    if (obj.rotation) {
                        obj.rotation.y = DEFAULT_RADIANS;
                    }
                }
            });

            if (skiObjects.filter(o => o).length > 0) {
                fixQuality();
                setupInteraction();
                showCurrentBoundaries();
            }
        }
    }

    // Fix quality
    function fixQuality() {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            console.log('[HERO-CENTERED] Quality fixed');
        }
    }

    // Setup interaction
    function setupInteraction() {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (!canvas) return;

        canvas.style.touchAction = 'none';
        canvas.style.userSelect = 'none';
        canvas.style.cursor = 'grab';

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mouseleave', handleEnd);

        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd, { passive: false });
        canvas.addEventListener('touchcancel', handleEnd, { passive: false });

        console.log('[HERO-CENTERED] Interaction ready!');
    }

    // Get ski from position WITH SCENE BOUNDARIES
    function getSkiFromPosition(x, canvasWidth) {
        // Convert canvas position to scene position
        const canvasPercentage = x / canvasWidth;

        // Check if click is outside scene boundaries
        if (canvasPercentage < SCENE_LEFT_BOUNDARY || canvasPercentage > SCENE_RIGHT_BOUNDARY) {
            return -1; // Outside scene
        }

        // Map to scene space (0 to 1 within the scene boundaries)
        const sceneWidth = SCENE_RIGHT_BOUNDARY - SCENE_LEFT_BOUNDARY;
        const scenePosition = (canvasPercentage - SCENE_LEFT_BOUNDARY) / sceneWidth;

        // Divide scene into 4 equal parts for the 4 skis
        if (scenePosition < 0.25) return 0;      // CARVE
        if (scenePosition < 0.50) return 1;      // PARK
        if (scenePosition < 0.75) return 2;      // ALLMOUNTAIN
        return 3;                                 // POWDER
    }

    // Show current boundaries
    function showCurrentBoundaries() {
        const leftPercent = (SCENE_LEFT_BOUNDARY * 100).toFixed(0);
        const rightPercent = (SCENE_RIGHT_BOUNDARY * 100).toFixed(0);
        console.log(`[HERO-CENTERED] Scene boundaries: ${leftPercent}% to ${rightPercent}% of canvas`);

        const sceneWidth = SCENE_RIGHT_BOUNDARY - SCENE_LEFT_BOUNDARY;
        const skiWidth = sceneWidth / 4;

        console.log('[HERO-CENTERED] Ski zones (% of canvas):');
        SKI_MAPPING.forEach((ski, i) => {
            const start = ((SCENE_LEFT_BOUNDARY + (i * skiWidth)) * 100).toFixed(0);
            const end = ((SCENE_LEFT_BOUNDARY + ((i + 1) * skiWidth)) * 100).toFixed(0);
            console.log(`  ${ski.name}: ${start}%-${end}%`);
        });
    }

    // Start interaction
    function handleStart(e) {
        if (!splineApp || skiObjects.length === 0) return;

        e.preventDefault();

        const canvas = e.target;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const x = clientX - rect.left;

        currentSki = getSkiFromPosition(x, rect.width);

        if (currentSki >= 0 && skiObjects[currentSki]) {
            isInteracting = true;
            startX = clientX;
            startRotation = currentRotations[currentSki];

            canvas.style.cursor = 'grabbing';

            const percentage = ((x / rect.width) * 100).toFixed(0);
            console.log(`[HERO-CENTERED] Rotating ${SKI_MAPPING[currentSki].name} (clicked at ${percentage}%)`);
        } else {
            const percentage = ((x / rect.width) * 100).toFixed(0);
            console.log(`[HERO-CENTERED] Click at ${percentage}% - outside scene boundaries`);
        }
    }

    // Handle move
    function handleMove(e) {
        if (!isInteracting || currentSki === null || currentSki < 0) return;

        e.preventDefault();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const deltaX = clientX - startX;

        const rotation = startRotation + (deltaX * 0.5);
        currentRotations[currentSki] = rotation;

        applyRotation(currentSki, rotation);
    }

    // End interaction
    function handleEnd(e) {
        if (!isInteracting) return;

        e.preventDefault();
        isInteracting = false;

        const canvas = e.target;
        if (canvas) canvas.style.cursor = 'grab';

        if (currentSki >= 0 && skiObjects[currentSki]) {
            animateBackToDefault(currentSki);
        }

        currentSki = null;
    }

    // Apply rotation
    function applyRotation(skiIndex, degrees) {
        const skiObject = skiObjects[skiIndex];
        if (!skiObject || !skiObject.rotation) return;

        const radians = degrees * (Math.PI / 180);
        skiObject.rotation.y = radians;

        if (splineApp.renderer && splineApp.renderer.render) {
            splineApp.renderer.render(splineApp.scene, splineApp.camera);
        }
    }

    // Animate back to 90 degrees
    function animateBackToDefault(skiIndex) {
        const startRotation = currentRotations[skiIndex];
        const endRotation = DEFAULT_ROTATION;
        const duration = 500;
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            const rotation = startRotation + (endRotation - startRotation) * eased;

            currentRotations[skiIndex] = rotation;
            applyRotation(skiIndex, rotation);

            if (progress < 1) {
                animationFrame = requestAnimationFrame(animate);
            }
        }

        if (animationFrame) cancelAnimationFrame(animationFrame);
        animate();
    }

    // Initialize
    function initialize() {
        if (!customElements.get('spline-viewer')) {
            setTimeout(initialize, 100);
            return;
        }
        createViewer();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        setTimeout(initialize, 100);
    }

    // Debug commands
    window.heroCentered = {
        // Adjust scene boundaries
        setBoundaries: (left, right) => {
            SCENE_LEFT_BOUNDARY = left;
            SCENE_RIGHT_BOUNDARY = right;
            console.log(`[HERO-CENTERED] Boundaries set to ${(left*100).toFixed(0)}%-${(right*100).toFixed(0)}%`);
            showCurrentBoundaries();
        },

        // Show current zones
        showZones: () => {
            showCurrentBoundaries();
        },

        // Test click position
        testClick: (percentFromLeft) => {
            const canvas = viewer?.shadowRoot?.querySelector('canvas') || viewer?.querySelector('canvas');
            if (canvas) {
                const rect = canvas.getBoundingClientRect();
                const x = rect.width * (percentFromLeft / 100);
                const ski = getSkiFromPosition(x, rect.width);
                if (ski >= 0) {
                    console.log(`Click at ${percentFromLeft}% would select ${SKI_MAPPING[ski].name}`);
                } else {
                    console.log(`Click at ${percentFromLeft}% is outside scene`);
                }
            }
        },

        // Adjust for centered scene
        centerScene: () => {
            // Common centered setup
            SCENE_LEFT_BOUNDARY = 0.3;  // Scene starts at 30%
            SCENE_RIGHT_BOUNDARY = 0.7; // Scene ends at 70%
            console.log('[HERO-CENTERED] Set to centered scene (30%-70%)');
            showCurrentBoundaries();
        },

        // Full width
        fullWidth: () => {
            SCENE_LEFT_BOUNDARY = 0;
            SCENE_RIGHT_BOUNDARY = 1;
            console.log('[HERO-CENTERED] Set to full width');
            showCurrentBoundaries();
        },

        status: () => {
            console.log('[HERO-CENTERED] Status:');
            console.log('Scene boundaries:', `${(SCENE_LEFT_BOUNDARY*100).toFixed(0)}%-${(SCENE_RIGHT_BOUNDARY*100).toFixed(0)}%`);
            showCurrentBoundaries();
        }
    };

    console.log('[HERO-CENTERED] Commands:');
    console.log('  heroCentered.setBoundaries(0.3, 0.7) - Adjust boundaries');
    console.log('  heroCentered.centerScene() - Set to centered (30%-70%)');
    console.log('  heroCentered.fullWidth() - Set to full width');
    console.log('  heroCentered.testClick(50) - Test click at 50% position');
})();
</script>

<!-- STYLES -->
<style>
  .spline-container {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .spline-container *,
  spline-viewer {
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }
</style>

<!-- WEBFLOW HTML -->
<div class="spline-container" id="hero-container"></div>