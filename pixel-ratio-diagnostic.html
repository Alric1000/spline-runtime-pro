<!-- DIAGNOSTIC: Check what's happening with pixel ratio -->
<!-- Add this to your page code temporarily to diagnose -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('===== PIXEL RATIO DIAGNOSTIC =====');
    console.log('Device Pixel Ratio:', window.devicePixelRatio);

    // Wait a bit for viewers to load
    setTimeout(() => {
        // Check all spline-viewer elements
        const viewers = document.querySelectorAll('spline-viewer');
        console.log(`Found ${viewers.length} spline-viewer elements`);

        viewers.forEach((viewer, index) => {
            console.log(`\n--- Viewer ${index + 1}: ${viewer.id} ---`);

            // Check shadow DOM
            const shadowRoot = viewer.shadowRoot;
            if (shadowRoot) {
                const canvas = shadowRoot.querySelector('canvas');
                if (canvas) {
                    const rect = canvas.getBoundingClientRect();
                    console.log('Canvas in shadow DOM:');
                    console.log('  Display size:', rect.width, 'x', rect.height);
                    console.log('  Buffer size:', canvas.width, 'x', canvas.height);
                    console.log('  Expected buffer:', rect.width * window.devicePixelRatio, 'x', rect.height * window.devicePixelRatio);
                    console.log('  Pixel ratio correct?', canvas.width === rect.width * window.devicePixelRatio ? '✅' : '❌');

                    // Try to find the renderer
                    if (viewer._scene && viewer._scene._renderer) {
                        console.log('  Renderer pixel ratio:', viewer._scene._renderer.getPixelRatio());
                    }
                } else {
                    console.log('  No canvas found in shadow DOM');
                }
            } else {
                console.log('  No shadow DOM found');

                // Check for regular canvas child
                const canvas = viewer.querySelector('canvas');
                if (canvas) {
                    const rect = canvas.getBoundingClientRect();
                    console.log('Canvas (regular DOM):');
                    console.log('  Display size:', rect.width, 'x', rect.height);
                    console.log('  Buffer size:', canvas.width, 'x', canvas.height);
                    console.log('  Expected buffer:', rect.width * window.devicePixelRatio, 'x', rect.height * window.devicePixelRatio);
                    console.log('  Pixel ratio correct?', canvas.width === rect.width * window.devicePixelRatio ? '✅' : '❌');
                }
            }

            // Check viewer properties
            console.log('Viewer properties:');
            Object.keys(viewer).forEach(key => {
                if (key.includes('scene') || key.includes('render') || key.includes('canvas')) {
                    console.log(`  ${key}:`, viewer[key]);
                }
            });
        });

        // Try to access Spline's internal renderer
        console.log('\n===== LOOKING FOR RENDERERS =====');
        viewers.forEach((viewer, index) => {
            // Various paths to try
            const paths = [
                () => viewer._scene?._renderer,
                () => viewer._application?._renderer,
                () => viewer.application?._renderer,
                () => viewer.scene?._renderer,
                () => viewer.spline?._renderer,
                () => viewer._spline?.renderer
            ];

            let renderer = null;
            for (const getPath of paths) {
                try {
                    renderer = getPath();
                    if (renderer) break;
                } catch (e) {}
            }

            if (renderer) {
                console.log(`Viewer ${index + 1} renderer found!`);
                if (renderer.getPixelRatio) {
                    console.log('  Current pixel ratio:', renderer.getPixelRatio());
                }
                if (renderer.setPixelRatio) {
                    console.log('  Setting pixel ratio to:', window.devicePixelRatio);
                    renderer.setPixelRatio(window.devicePixelRatio);
                }
            }
        });

    }, 3000); // Wait 3 seconds for scenes to load

    // Global helper to manually fix pixel ratio
    window.fixSplinePixelRatio = function() {
        const dpr = window.devicePixelRatio;
        const viewers = document.querySelectorAll('spline-viewer');

        viewers.forEach(viewer => {
            // Try shadow DOM first
            const shadowRoot = viewer.shadowRoot;
            const canvas = shadowRoot ? shadowRoot.querySelector('canvas') : viewer.querySelector('canvas');

            if (canvas) {
                const rect = canvas.getBoundingClientRect();
                const width = Math.floor(rect.width);
                const height = Math.floor(rect.height);

                console.log(`Fixing canvas: ${width}x${height} @ ${dpr}x`);

                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';

                // Try to find and update renderer
                const paths = [
                    () => viewer._scene?._renderer,
                    () => viewer._application?._renderer,
                    () => viewer.application?._renderer
                ];

                for (const getPath of paths) {
                    try {
                        const renderer = getPath();
                        if (renderer && renderer.setPixelRatio) {
                            renderer.setPixelRatio(dpr);
                            if (renderer.setSize) {
                                renderer.setSize(width, height, false);
                            }
                            console.log('Renderer updated!');
                            break;
                        }
                    } catch (e) {}
                }
            }
        });
    };

    console.log('💡 Run window.fixSplinePixelRatio() to manually fix pixel ratio');
});
</script>