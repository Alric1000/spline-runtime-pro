<!-- HERO SCENE - FIND CORRECT GROUP NAMES -->
<!-- Searches for parent groups containing ski objects -->

<script>
(function() {
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';
    const HERO_SCENE = 'hero-animation';
    const dpr = window.devicePixelRatio || 1;

    console.log('[HERO-4SKIS] Finding correct ski groups...');

    let viewer = null;
    let splineApp = null;
    let skiGroups = [];
    let isInteracting = false;
    let currentSki = null;
    let startX = 0;
    let currentRotations = [0, 0, 0, 0];
    let animationFrame = null;

    // Expected ski group names based on your info
    const EXPECTED_SKI_NAMES = ['CARVE', 'PARK', 'ALLMOUNTAIN', 'POWDER'];

    // Will be populated with actual found names
    let SKI_NAMES = [];

    // Wait for spline-viewer
    function waitForSplineViewer() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (customElements.get('spline-viewer')) {
                    clearInterval(check);
                    resolve();
                }
            }, 50);
        });
    }

    // Create viewer
    function createHeroViewer(container) {
        viewer = document.createElement('spline-viewer');
        viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${HERO_SCENE}/scene.splinecode`);
        viewer.setAttribute('id', 'hero-viewer');
        viewer.style.width = '100%';
        viewer.style.height = '100%';
        viewer.style.display = 'block';

        container.appendChild(viewer);

        viewer.addEventListener('load', () => {
            console.log('[HERO-4SKIS] Scene loaded');
            setTimeout(() => {
                initializeScene();
            }, 1000);
        });

        return viewer;
    }

    // Find all objects recursively
    function findAllObjectsRecursive(obj, path = '') {
        let results = [];

        if (obj && obj.name) {
            const fullPath = path ? `${path}/${obj.name}` : obj.name;
            results.push({
                name: obj.name,
                path: fullPath,
                type: obj.type || obj.constructor.name,
                object: obj,
                hasRotation: !!(obj.rotation || (obj.transform && obj.transform.rotation))
            });
        }

        // Check children
        if (obj && obj.children && Array.isArray(obj.children)) {
            for (const child of obj.children) {
                results = results.concat(findAllObjectsRecursive(child, obj.name));
            }
        }

        return results;
    }

    // Initialize scene and find ski groups
    function initializeScene() {
        splineApp = viewer._spline;

        if (splineApp) {
            console.log('[HERO-4SKIS] Spline app found, analyzing structure...');

            // Get all objects with hierarchy
            let allObjects = [];

            // Try through scene
            if (splineApp.scene) {
                allObjects = findAllObjectsRecursive(splineApp.scene);
            }

            // Also try getAllObjects for flat list
            if (splineApp.getAllObjects) {
                const flatObjects = splineApp.getAllObjects();
                console.log('[HERO-4SKIS] Flat object list:', flatObjects.map(o => o.name));
            }

            // Log hierarchical structure
            console.log('[HERO-4SKIS] Full scene hierarchy:');
            allObjects.forEach(obj => {
                if (obj.hasRotation) {
                    console.log(`  ${obj.path} (${obj.type}) - ROTATABLE`);
                }
            });

            // Find ski groups by expected names
            for (const expectedName of EXPECTED_SKI_NAMES) {
                const found = allObjects.find(obj =>
                    obj.name === expectedName ||
                    obj.name.toUpperCase().includes(expectedName)
                );

                if (found) {
                    console.log(`[HERO-4SKIS] Found ski group: ${found.name}`);
                    SKI_NAMES.push(found.name);
                    skiGroups.push(found.object);
                }
            }

            // If not found by expected names, look for groups containing "Ski_HighPoly"
            if (SKI_NAMES.length === 0) {
                console.log('[HERO-4SKIS] Looking for parent groups of Ski_HighPoly objects...');

                const skiMeshes = allObjects.filter(obj =>
                    obj.name.includes('Ski_HighPoly') ||
                    obj.name.includes('normalmap test')
                );

                // Find their parent groups
                const parentGroups = new Set();
                skiMeshes.forEach(mesh => {
                    const parentPath = mesh.path.split('/')[0];
                    if (parentPath && parentPath !== mesh.name) {
                        parentGroups.add(parentPath);
                    }
                });

                SKI_NAMES = Array.from(parentGroups);
                console.log('[HERO-4SKIS] Found parent groups:', SKI_NAMES);

                // Get the actual group objects
                SKI_NAMES.forEach(name => {
                    const group = splineApp.findObjectByName(name);
                    if (group) {
                        skiGroups.push(group);
                    }
                });
            }

            if (SKI_NAMES.length > 0) {
                console.log('[HERO-4SKIS] Using ski groups:', SKI_NAMES);
                fixQuality();
                setupInteraction();
            } else {
                console.warn('[HERO-4SKIS] No ski groups found!');
            }

        } else {
            console.warn('[HERO-4SKIS] Spline app not found, retrying...');
            setTimeout(initializeScene, 500);
        }
    }

    // Fix quality
    function fixQuality() {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            console.log('[HERO-4SKIS] Quality fixed');
        }
    }

    // Setup interaction
    function setupInteraction() {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (!canvas) return;

        canvas.style.touchAction = 'none';
        canvas.style.userSelect = 'none';
        canvas.style.cursor = 'grab';

        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);

        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd, { passive: false });

        console.log('[HERO-4SKIS] Interaction ready');
    }

    // Get ski from position
    function getSkiFromPosition(x, canvasWidth) {
        const zone = Math.floor((x / canvasWidth) * SKI_NAMES.length);
        return Math.min(Math.max(zone, 0), SKI_NAMES.length - 1);
    }

    // Start interaction
    function handleStart(e) {
        if (!splineApp || SKI_NAMES.length === 0) return;

        e.preventDefault();

        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const x = clientX - rect.left;

        currentSki = getSkiFromPosition(x, rect.width);
        isInteracting = true;
        startX = clientX;

        canvas.style.cursor = 'grabbing';
        console.log(`[HERO-4SKIS] Starting rotation of ${SKI_NAMES[currentSki]}`);
    }

    // Handle move
    function handleMove(e) {
        if (!isInteracting || currentSki === null) return;

        e.preventDefault();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const deltaX = clientX - startX;
        const rotation = deltaX * 0.5;
        currentRotations[currentSki] = rotation;

        applyRotation(currentSki, rotation);
    }

    // End interaction
    function handleEnd(e) {
        if (!isInteracting) return;

        e.preventDefault();
        isInteracting = false;

        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');
        if (canvas) canvas.style.cursor = 'grab';

        if (currentSki !== null) {
            animateBackToOriginal(currentSki);
        }

        currentSki = null;
    }

    // Apply rotation
    function applyRotation(skiIndex, degrees) {
        if (!splineApp || skiIndex >= SKI_NAMES.length) return;

        const skiName = SKI_NAMES[skiIndex];
        const skiObject = skiGroups[skiIndex] || splineApp.findObjectByName(skiName);

        if (skiObject) {
            const radians = degrees * (Math.PI / 180);

            // Try multiple rotation methods
            if (skiObject.rotation) {
                skiObject.rotation.y = radians;
            } else if (skiObject.transform && skiObject.transform.rotation) {
                skiObject.transform.rotation.y = radians;
            } else if (skiObject.setRotationY) {
                skiObject.setRotationY(radians);
            }

            // Force update
            if (splineApp.renderer && splineApp.renderer.render) {
                splineApp.renderer.render(splineApp.scene, splineApp.camera);
            }

            console.log(`[HERO-4SKIS] Rotated ${skiName} to ${degrees.toFixed(1)}Â°`);
        } else {
            console.warn(`[HERO-4SKIS] Could not find ski: ${skiName}`);
        }
    }

    // Animate back
    function animateBackToOriginal(skiIndex) {
        const startRotation = currentRotations[skiIndex];
        const endRotation = 0;
        const duration = 500;
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            const rotation = startRotation + (endRotation - startRotation) * eased;

            currentRotations[skiIndex] = rotation;
            applyRotation(skiIndex, rotation);

            if (progress < 1) {
                animationFrame = requestAnimationFrame(animate);
            }
        }

        if (animationFrame) cancelAnimationFrame(animationFrame);
        animate();
    }

    // Initialize
    async function initialize() {
        await waitForSplineViewer();

        const container = document.querySelector('.spline-container') ||
                         document.getElementById('hero-container');

        if (!container) {
            console.error('[HERO-4SKIS] No container found');
            return;
        }

        createHeroViewer(container);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        setTimeout(initialize, 100);
    }

    // Debug commands
    window.hero4Skis = {
        status: () => {
            console.log('[HERO-4SKIS] Status:');
            console.log('- Viewer:', !!viewer);
            console.log('- App:', !!splineApp);
            console.log('- Ski groups found:', SKI_NAMES);
            console.log('- Ski objects:', skiGroups.map(g => g ? g.name : 'not found'));
        },

        testRotation: (skiIndex, degrees) => {
            if (SKI_NAMES.length === 0) {
                console.log('[HERO-4SKIS] No ski groups found yet');
                return;
            }
            if (skiIndex >= 0 && skiIndex < SKI_NAMES.length) {
                console.log(`[HERO-4SKIS] Testing ${SKI_NAMES[skiIndex]} at ${degrees}Â°`);
                applyRotation(skiIndex, degrees);
                setTimeout(() => animateBackToOriginal(skiIndex), 1000);
            }
        },

        findHierarchy: () => {
            if (splineApp && splineApp.scene) {
                const all = findAllObjectsRecursive(splineApp.scene);
                console.log('[HERO-4SKIS] Full hierarchy:');
                all.forEach(obj => {
                    const indent = '  '.repeat(obj.path.split('/').length - 1);
                    console.log(`${indent}${obj.name} (${obj.type})`);
                });
            }
        },

        findRotatable: () => {
            if (splineApp && splineApp.scene) {
                const all = findAllObjectsRecursive(splineApp.scene);
                const rotatable = all.filter(obj => obj.hasRotation);
                console.log('[HERO-4SKIS] Rotatable objects:');
                rotatable.forEach(obj => {
                    console.log(`- ${obj.path}`);
                });
            }
        }
    };

    console.log('[HERO-4SKIS] Commands: hero4Skis.findHierarchy(), hero4Skis.findRotatable()');
})();
</script>

<!-- WEBFLOW HTML -->
<div class="spline-container" id="hero-container"></div>