<!-- HERO SCENE - UUID-BASED ROTATION -->
<!-- Uses UUID identifiers for ski groups -->

<script>
(function() {
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';
    const HERO_SCENE = 'hero-animation';
    const dpr = window.devicePixelRatio || 1;

    console.log('[HERO-UUID] Starting with UUID-based rotation');

    let viewer = null;
    let splineApp = null;
    let skiGroups = [];
    let isInteracting = false;
    let currentSki = null;
    let startX = 0;
    let currentRotations = [0, 0, 0, 0];
    let animationFrame = null;

    // We'll find these UUIDs dynamically
    let SKI_UUIDS = [];

    // Create viewer
    function createViewer() {
        const container = document.querySelector('.spline-container') ||
                         document.getElementById('hero-container');

        if (!container) {
            console.error('[HERO-UUID] No container found');
            return;
        }

        viewer = document.createElement('spline-viewer');
        viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${HERO_SCENE}/scene.splinecode`);
        viewer.style.width = '100%';
        viewer.style.height = '100%';
        viewer.style.display = 'block';

        container.appendChild(viewer);
        console.log('[HERO-UUID] Viewer created');

        // Wait for load
        setTimeout(findSkiGroups, 2000);
    }

    // Find ski groups by their UUIDs
    function findSkiGroups() {
        splineApp = viewer._spline;

        if (!splineApp) {
            console.log('[HERO-UUID] App not ready, retrying...');
            setTimeout(findSkiGroups, 500);
            return;
        }

        console.log('[HERO-UUID] App found! Finding ski groups...');

        // Get all objects
        if (splineApp.getAllObjects) {
            const allObjects = splineApp.getAllObjects();

            // Find objects that look like UUIDs
            const uuidPattern = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;
            const uuidObjects = allObjects.filter(obj =>
                obj.name && uuidPattern.test(obj.name)
            );

            if (uuidObjects.length > 0) {
                console.log(`[HERO-UUID] Found ${uuidObjects.length} UUID-named objects`);
                SKI_UUIDS = uuidObjects.map(obj => obj.name);
                skiGroups = uuidObjects;

                console.log('[HERO-UUID] UUIDs found:', SKI_UUIDS);

                // Test if they're rotatable
                uuidObjects.forEach((obj, i) => {
                    console.log(`UUID ${i}: ${obj.name} - Rotatable: ${!!obj.rotation}`);
                });

                setupInteraction();
                fixQuality();
            } else {
                // Try scene.children for UUID-named groups
                console.log('[HERO-UUID] Checking scene.children for UUIDs...');

                if (splineApp.scene && splineApp.scene.children) {
                    const sceneUUIDs = splineApp.scene.children.filter(child =>
                        child.name && uuidPattern.test(child.name)
                    );

                    if (sceneUUIDs.length > 0) {
                        console.log(`[HERO-UUID] Found ${sceneUUIDs.length} UUID groups in scene`);
                        SKI_UUIDS = sceneUUIDs.map(obj => obj.name);
                        skiGroups = sceneUUIDs;

                        console.log('[HERO-UUID] Scene UUIDs:', SKI_UUIDS);

                        setupInteraction();
                        fixQuality();
                    } else {
                        console.log('[HERO-UUID] No UUID-named objects found. Trying manual UUID...');

                        // Try the UUID you provided
                        const testUUID = 'c5d6f3ff-e0a8-42e3-8fa3-3ab4f6a6a82c';
                        const testObj = splineApp.findObjectByName(testUUID);

                        if (testObj) {
                            console.log('[HERO-UUID] Found CARVE with UUID:', testUUID);
                            console.log('Object:', testObj);

                            // Prompt for other UUIDs
                            console.log('[HERO-UUID] Please provide the other ski UUIDs');
                            console.log('Use: heroUUID.setUUIDs(["uuid1", "uuid2", "uuid3", "uuid4"])');
                        }
                    }
                }
            }
        }
    }

    // Fix quality
    function fixQuality() {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            console.log('[HERO-UUID] Quality fixed');
        }
    }

    // Setup interaction
    function setupInteraction() {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (!canvas) return;

        canvas.style.touchAction = 'none';
        canvas.style.userSelect = 'none';
        canvas.style.cursor = 'grab';

        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);

        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd, { passive: false });

        console.log('[HERO-UUID] Interaction ready');
    }

    // Get ski from position
    function getSkiFromPosition(x, canvasWidth) {
        const zone = Math.floor((x / canvasWidth) * SKI_UUIDS.length);
        return Math.min(Math.max(zone, 0), SKI_UUIDS.length - 1);
    }

    // Start interaction
    function handleStart(e) {
        if (!splineApp || SKI_UUIDS.length === 0) return;

        e.preventDefault();

        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const x = clientX - rect.left;

        currentSki = getSkiFromPosition(x, rect.width);
        isInteracting = true;
        startX = clientX;

        canvas.style.cursor = 'grabbing';
        console.log(`[HERO-UUID] Starting rotation of ski ${currentSki + 1}`);
    }

    // Handle move
    function handleMove(e) {
        if (!isInteracting || currentSki === null) return;

        e.preventDefault();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const deltaX = clientX - startX;
        const rotation = deltaX * 0.5;
        currentRotations[currentSki] = rotation;

        applyRotation(currentSki, rotation);
    }

    // End interaction
    function handleEnd(e) {
        if (!isInteracting) return;

        e.preventDefault();
        isInteracting = false;

        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');
        if (canvas) canvas.style.cursor = 'grab';

        if (currentSki !== null) {
            animateBackToOriginal(currentSki);
        }

        currentSki = null;
    }

    // Apply rotation
    function applyRotation(skiIndex, degrees) {
        if (!splineApp || skiIndex >= SKI_UUIDS.length) return;

        const uuid = SKI_UUIDS[skiIndex];
        const skiObject = skiGroups[skiIndex] || splineApp.findObjectByName(uuid);

        if (skiObject && skiObject.rotation) {
            skiObject.rotation.y = degrees * (Math.PI / 180);
            console.log(`[HERO-UUID] Rotated ski ${skiIndex + 1} (${uuid.substring(0, 8)}...) to ${degrees.toFixed(1)}°`);
        }
    }

    // Animate back
    function animateBackToOriginal(skiIndex) {
        const startRotation = currentRotations[skiIndex];
        const duration = 500;
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            const rotation = startRotation * (1 - eased);

            currentRotations[skiIndex] = rotation;
            applyRotation(skiIndex, rotation);

            if (progress < 1) {
                animationFrame = requestAnimationFrame(animate);
            }
        }

        if (animationFrame) cancelAnimationFrame(animationFrame);
        animate();
    }

    // Initialize
    function initialize() {
        if (!customElements.get('spline-viewer')) {
            setTimeout(initialize, 100);
            return;
        }
        createViewer();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        setTimeout(initialize, 100);
    }

    // Global commands
    window.heroUUID = {
        // Manually set UUIDs if auto-detection fails
        setUUIDs: (uuids) => {
            if (!Array.isArray(uuids) || uuids.length === 0) {
                console.log('❌ Please provide an array of UUIDs');
                return;
            }

            SKI_UUIDS = uuids;
            skiGroups = [];

            console.log('[HERO-UUID] Setting UUIDs:', uuids);

            // Find the objects
            uuids.forEach((uuid, i) => {
                const obj = splineApp.findObjectByName(uuid);
                if (obj) {
                    skiGroups.push(obj);
                    console.log(`✅ Found ski ${i + 1}: ${uuid.substring(0, 8)}...`);
                } else {
                    console.log(`❌ Not found: ${uuid}`);
                }
            });

            if (skiGroups.length > 0) {
                setupInteraction();
                fixQuality();
                console.log('[HERO-UUID] Ready for rotation!');
            }
        },

        // Test rotation
        testRotation: (skiIndex, degrees) => {
            if (SKI_UUIDS.length === 0) {
                console.log('❌ No UUIDs set. Use heroUUID.setUUIDs() first');
                return;
            }

            console.log(`[HERO-UUID] Testing ski ${skiIndex + 1}`);
            applyRotation(skiIndex, degrees);
            setTimeout(() => animateBackToOriginal(skiIndex), 1000);
        },

        // Status
        status: () => {
            console.log('[HERO-UUID] Status:');
            console.log('- Viewer:', !!viewer);
            console.log('- App:', !!splineApp);
            console.log('- UUIDs found:', SKI_UUIDS.length);
            console.log('- UUIDs:', SKI_UUIDS);
        },

        // Find all UUIDs in scene
        findUUIDs: () => {
            if (!splineApp) {
                console.log('❌ App not ready');
                return;
            }

            const uuidPattern = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i;
            const allObjects = splineApp.getAllObjects ? splineApp.getAllObjects() : [];

            const uuids = allObjects
                .filter(obj => obj.name && uuidPattern.test(obj.name))
                .map(obj => obj.name);

            console.log('[HERO-UUID] All UUIDs in scene:', uuids);
            return uuids;
        },

        // Test UUID rotation
        rotateUUID: (uuid, degrees) => {
            if (!splineApp) {
                console.log('❌ App not ready');
                return;
            }

            const obj = splineApp.findObjectByName(uuid);
            if (obj && obj.rotation) {
                obj.rotation.y = degrees * (Math.PI / 180);
                console.log(`✅ Rotated ${uuid.substring(0, 8)}... to ${degrees}°`);
            } else {
                console.log(`❌ UUID ${uuid} not found or not rotatable`);
            }
        }
    };

    console.log('[HERO-UUID] Commands:');
    console.log('  heroUUID.findUUIDs() - Find all UUIDs');
    console.log('  heroUUID.setUUIDs([...]) - Set ski UUIDs manually');
    console.log('  heroUUID.rotateUUID(uuid, degrees) - Test rotation');
    console.log('  heroUUID.testRotation(0-3, degrees) - Test ski rotation');
})();
</script>

<!-- WEBFLOW HTML -->
<div class="spline-container" id="hero-container"></div>