<!-- AGGRESSIVE FIX: Force pixel ratio on spline-viewer elements -->
<!-- Add this to your GLOBAL FOOTER after the conversion script -->

<script>
(function() {
    const dpr = window.devicePixelRatio || 1;
    console.log(`[AGGRESSIVE PATCH] Device pixel ratio: ${dpr}`);

    // Patch the spline-viewer custom element after it's defined
    function patchSplineViewer() {
        const SplineViewerClass = customElements.get('spline-viewer');
        if (!SplineViewerClass) {
            setTimeout(patchSplineViewer, 100);
            return;
        }

        console.log('[AGGRESSIVE PATCH] Found spline-viewer class, patching...');

        // Override connectedCallback or any load method
        const originalConnectedCallback = SplineViewerClass.prototype.connectedCallback;
        if (originalConnectedCallback) {
            SplineViewerClass.prototype.connectedCallback = function() {
                console.log('[AGGRESSIVE PATCH] spline-viewer connecting...');

                // Call original
                originalConnectedCallback.call(this);

                // Force pixel ratio after a delay
                const viewer = this;
                const fixPixelRatio = () => {
                    // Try multiple times
                    [100, 500, 1000, 2000].forEach(delay => {
                        setTimeout(() => {
                            // Find canvas (shadow DOM or regular)
                            const canvas = viewer.shadowRoot ?
                                viewer.shadowRoot.querySelector('canvas') :
                                viewer.querySelector('canvas');

                            if (canvas) {
                                const rect = canvas.getBoundingClientRect();
                                const width = Math.floor(rect.width);
                                const height = Math.floor(rect.height);

                                if (canvas.width !== width * dpr) {
                                    console.log(`[AGGRESSIVE PATCH] Fixing canvas from ${canvas.width}x${canvas.height} to ${width * dpr}x${height * dpr}`);
                                    canvas.width = width * dpr;
                                    canvas.height = height * dpr;
                                    canvas.style.width = width + 'px';
                                    canvas.style.height = height + 'px';
                                }

                                // Try to fix renderer
                                const paths = [
                                    viewer._scene?._renderer,
                                    viewer._application?._renderer,
                                    viewer.application?._renderer,
                                    viewer.renderer,
                                    viewer._renderer
                                ];

                                for (const renderer of paths) {
                                    if (renderer && renderer.setPixelRatio) {
                                        renderer.setPixelRatio(dpr);
                                        if (renderer.setSize) {
                                            renderer.setSize(width, height, false);
                                        }
                                        console.log('[AGGRESSIVE PATCH] Renderer fixed!');
                                        break;
                                    }
                                }
                            }
                        }, delay);
                    });
                };

                // Fix on various events
                this.addEventListener('load', fixPixelRatio);
                fixPixelRatio(); // Start immediately
            };
        }

        // Also monitor for new viewers
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.tagName === 'SPLINE-VIEWER') {
                        console.log('[AGGRESSIVE PATCH] New spline-viewer detected');

                        setTimeout(() => {
                            const canvas = node.shadowRoot ?
                                node.shadowRoot.querySelector('canvas') :
                                node.querySelector('canvas');

                            if (canvas) {
                                const rect = canvas.getBoundingClientRect();
                                const width = Math.floor(rect.width);
                                const height = Math.floor(rect.height);

                                canvas.width = width * dpr;
                                canvas.height = height * dpr;
                                canvas.style.width = width + 'px';
                                canvas.style.height = height + 'px';

                                console.log('[AGGRESSIVE PATCH] Fixed new viewer canvas');
                            }
                        }, 1000);
                    }
                });
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        console.log('[AGGRESSIVE PATCH] Spline-viewer patched successfully');
    }

    // Start patching
    patchSplineViewer();

    // Also patch any existing viewers immediately
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            document.querySelectorAll('spline-viewer').forEach(viewer => {
                const canvas = viewer.shadowRoot ?
                    viewer.shadowRoot.querySelector('canvas') :
                    viewer.querySelector('canvas');

                if (canvas) {
                    const rect = canvas.getBoundingClientRect();
                    const width = Math.floor(rect.width);
                    const height = Math.floor(rect.height);

                    if (canvas.width !== width * dpr) {
                        canvas.width = width * dpr;
                        canvas.height = height * dpr;
                        canvas.style.width = width + 'px';
                        canvas.style.height = height + 'px';
                        console.log('[AGGRESSIVE PATCH] Fixed existing viewer');
                    }
                }
            });
        }, 2000);
    });
})();
</script>