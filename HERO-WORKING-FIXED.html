<!-- HERO SCENE - WORKING VERSION WITH FIXES -->
<!-- Fixed timing issues and Spline API access -->

<script>
(function() {
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';
    const HERO_SCENE = 'hero-animation';
    const dpr = window.devicePixelRatio || 1;

    console.log('[HERO-4SKIS] Initializing combined scene with rotation');

    let viewer = null;
    let splineApp = null;
    let isInteracting = false;
    let currentSki = null;
    let startX = 0;
    let startRotation = 0;
    let currentRotation = 0;
    let animationFrame = null;

    // Ski names matching your Spline scene
    const SKI_NAMES = ['ALLMOUNTAIN', 'PARK', 'CARVE', 'POWDER'];

    // Original rotations for spring-back
    const originalRotations = [0, 0, 0, 0];

    // Wait for spline-viewer
    function waitForSplineViewer() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (customElements.get('spline-viewer')) {
                    clearInterval(check);
                    resolve();
                }
            }, 50);
        });
    }

    // Create the hero viewer
    function createHeroViewer(container) {
        viewer = document.createElement('spline-viewer');
        viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${HERO_SCENE}/scene.splinecode`);
        viewer.setAttribute('id', 'hero-viewer');
        viewer.style.width = '100%';
        viewer.style.height = '100%';
        viewer.style.display = 'block';

        container.appendChild(viewer);

        // Setup after load with longer delay for Spline to fully initialize
        viewer.addEventListener('load', () => {
            console.log('[HERO-4SKIS] Scene loaded, waiting for full initialization');

            // Wait for Spline app to be ready
            setTimeout(() => {
                fixQuality(viewer);
                findSplineApp();
                setupInteraction();
            }, 1000);
        });

        return viewer;
    }

    // Find and store Spline app reference
    function findSplineApp() {
        // Try multiple paths to find Spline app
        const paths = [
            () => viewer._runtime?.exports?.getSplineRuntime?.(),
            () => viewer._runtime?.exports?.runtime,
            () => viewer._application,
            () => viewer.application,
            () => viewer._app,
            () => viewer.spline,
            () => viewer.shadowRoot?.querySelector('canvas')?._splineApp,
            () => viewer.querySelector('canvas')?._splineApp
        ];

        for (const getPath of paths) {
            try {
                const app = getPath();
                if (app) {
                    splineApp = app;
                    console.log('[HERO-4SKIS] Found Spline app');

                    // Log available objects for debugging
                    if (app.getAllObjects) {
                        const objects = app.getAllObjects();
                        console.log('[HERO-4SKIS] Scene objects:', objects.map(o => o.name));
                    } else if (app.scene && app.scene.children) {
                        console.log('[HERO-4SKIS] Scene children:', app.scene.children.map(o => o.name));
                    }

                    return;
                }
            } catch (e) {}
        }

        console.warn('[HERO-4SKIS] Could not find Spline app, retrying...');

        // Retry after delay
        setTimeout(() => {
            findSplineApp();
        }, 500);
    }

    // Fix quality
    function fixQuality(viewer) {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            console.log('[HERO-4SKIS] Quality fixed');
        }
    }

    // Determine which ski based on X position
    function getSkiFromPosition(x, canvasWidth) {
        const zone = Math.floor((x / canvasWidth) * 4);
        return Math.min(Math.max(zone, 0), 3);
    }

    // Setup interaction with better timing
    function setupInteraction() {
        // Try both shadow DOM and regular DOM
        let canvas = viewer.shadowRoot?.querySelector('canvas');
        if (!canvas) {
            canvas = viewer.querySelector('canvas');
        }

        if (!canvas) {
            console.warn('[HERO-4SKIS] Canvas not found, retrying...');
            setTimeout(setupInteraction, 500);
            return;
        }

        // Force override styles with setAttribute for better compatibility
        canvas.setAttribute('style',
            'width: 100% !important;' +
            'height: 100% !important;' +
            'touch-action: none !important;' +
            'user-select: none !important;' +
            '-webkit-user-select: none !important;' +
            'pointer-events: auto !important;' +
            'cursor: grab !important;'
        );

        // Also set individual properties as backup
        canvas.style.touchAction = 'none';
        canvas.style.userSelect = 'none';
        canvas.style.webkitUserSelect = 'none';
        canvas.style.pointerEvents = 'auto';
        canvas.style.cursor = 'grab';

        // Mouse events
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mouseleave', handleEnd);

        // Touch events
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd, { passive: false });
        canvas.addEventListener('touchcancel', handleEnd, { passive: false });

        console.log('[HERO-4SKIS] Interaction ready');

        // Verify styles were applied
        setTimeout(() => {
            const styles = window.getComputedStyle(canvas);
            console.log('[HERO-4SKIS] Applied styles check:', {
                touchAction: styles.touchAction,
                cursor: styles.cursor,
                pointerEvents: styles.pointerEvents
            });
        }, 100);
    }

    // Start interaction
    function handleStart(e) {
        e.preventDefault();
        e.stopPropagation();

        const canvas = e.target;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const x = clientX - rect.left;

        currentSki = getSkiFromPosition(x, rect.width);
        isInteracting = true;
        startX = clientX;
        startRotation = currentRotation;

        canvas.style.cursor = 'grabbing';
        console.log(`[HERO-4SKIS] Interacting with ${SKI_NAMES[currentSki]}`);
    }

    // Move during interaction
    function handleMove(e) {
        if (!isInteracting || currentSki === null) return;

        e.preventDefault();
        e.stopPropagation();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const deltaX = clientX - startX;
        const rotation = startRotation + (deltaX * 0.5);

        applyRotation(currentSki, rotation);
        currentRotation = rotation;
    }

    // End interaction
    function handleEnd(e) {
        if (!isInteracting) return;

        e.preventDefault();
        e.stopPropagation();

        isInteracting = false;

        if (currentSki !== null) {
            animateBackToOriginal(currentSki);
        }

        const canvas = e.target;
        if (canvas) canvas.style.cursor = 'grab';

        currentSki = null;
    }

    // Apply rotation with better object finding
    function applyRotation(skiIndex, rotation) {
        if (!splineApp) {
            console.warn('[HERO-4SKIS] Spline app not ready');
            return;
        }

        try {
            const skiName = SKI_NAMES[skiIndex];
            let skiObject = null;

            // Method 1: findObjectByName
            if (splineApp.findObjectByName) {
                skiObject = splineApp.findObjectByName(skiName);
            }

            // Method 2: findObjectById (sometimes names are IDs)
            if (!skiObject && splineApp.findObjectById) {
                skiObject = splineApp.findObjectById(skiName);
            }

            // Method 3: Through scene
            if (!skiObject && splineApp.scene) {
                if (splineApp.scene.getObjectByName) {
                    skiObject = splineApp.scene.getObjectByName(skiName);
                } else if (splineApp.scene.children) {
                    skiObject = splineApp.scene.children.find(obj => obj.name === skiName);
                }
            }

            // Method 4: getAllObjects
            if (!skiObject && splineApp.getAllObjects) {
                const objects = splineApp.getAllObjects();
                skiObject = objects.find(obj => obj.name === skiName);
            }

            // Method 5: Try with _runtime
            if (!skiObject && viewer._runtime?.exports?.findObjectByName) {
                skiObject = viewer._runtime.exports.findObjectByName(skiName);
            }

            if (skiObject) {
                // Apply rotation (Spline uses radians)
                if (skiObject.rotation) {
                    skiObject.rotation.y = rotation * (Math.PI / 180);
                } else if (skiObject.transform) {
                    skiObject.transform.rotation.y = rotation * (Math.PI / 180);
                }

                console.log(`[HERO-4SKIS] Rotating ${skiName} to ${rotation.toFixed(1)}°`);
            } else {
                console.warn(`[HERO-4SKIS] Could not find object: ${skiName}`);

                // Log what we do have for debugging
                if (splineApp.getAllObjects) {
                    const objects = splineApp.getAllObjects();
                    console.log('[HERO-4SKIS] Available objects:', objects.map(o => o.name).slice(0, 10));
                }
            }
        } catch (error) {
            console.warn('[HERO-4SKIS] Rotation error:', error);
        }
    }

    // Animate back to original
    function animateBackToOriginal(skiIndex) {
        const startRot = currentRotation;
        const endRot = originalRotations[skiIndex];
        const duration = 500;
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            const rotation = startRot + (endRot - startRot) * eased;

            applyRotation(skiIndex, rotation);

            if (progress < 1) {
                animationFrame = requestAnimationFrame(animate);
            } else {
                currentRotation = endRot;
            }
        }

        if (animationFrame) cancelAnimationFrame(animationFrame);
        animate();
    }

    // Initialize
    async function initialize() {
        await waitForSplineViewer();

        // Find container - try multiple selectors
        let container = document.getElementById('hero-container');

        if (!container) {
            container = document.querySelector('.hero-container');
        }

        if (!container) {
            container = document.querySelector('.spline-container');
        }

        if (!container) {
            console.error('[HERO-4SKIS] No container found');
            return;
        }

        console.log('[HERO-4SKIS] Found container:', container.className || container.id);

        createHeroViewer(container);
    }

    // Start
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        setTimeout(initialize, 100);
    }

    // Enhanced debug commands
    window.hero4Skis = {
        status: () => {
            console.log('[HERO-4SKIS] Status:');
            console.log('- Scene:', HERO_SCENE);
            console.log('- Skis:', SKI_NAMES.join(', '));
            console.log('- Viewer ready:', !!viewer);
            console.log('- Spline app ready:', !!splineApp);
        },

        testRotation: (skiIndex, degrees) => {
            if (skiIndex >= 0 && skiIndex < 4) {
                console.log(`[HERO-4SKIS] Testing ${SKI_NAMES[skiIndex]} at ${degrees}°`);
                applyRotation(skiIndex, degrees);
                setTimeout(() => animateBackToOriginal(skiIndex), 1000);
            }
        },

        debugCanvas: () => {
            const canvas = viewer?.shadowRoot?.querySelector('canvas') ||
                          viewer?.querySelector('canvas');
            if (canvas) {
                const styles = window.getComputedStyle(canvas);
                console.log('Canvas styles:', {
                    pointerEvents: styles.pointerEvents,
                    userSelect: styles.userSelect,
                    touchAction: styles.touchAction,
                    cursor: styles.cursor
                });
            }
        },

        findObjects: () => {
            if (splineApp) {
                if (splineApp.getAllObjects) {
                    const objects = splineApp.getAllObjects();
                    console.log('[HERO-4SKIS] All objects:', objects.map(o => ({ name: o.name, type: o.type })));
                } else {
                    console.log('[HERO-4SKIS] getAllObjects not available');
                }
            } else {
                console.log('[HERO-4SKIS] Spline app not found yet');
            }
        },

        getApp: () => splineApp
    };

    console.log('[HERO-4SKIS] Debug commands: hero4Skis.status(), hero4Skis.findObjects(), hero4Skis.testRotation(0-3, degrees)');
})();
</script>

<!-- PAGE CODE -->
<style>
  .spline-container,
  .spline-container *,
  spline-viewer {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }

  @media (max-width: 768px) {
    .spline-container {
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
      user-select: none !important;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const span = document.getElementById('typeSpan');
    if (!span) return;

    const defaultText = span.textContent;
    const containers = document.querySelectorAll('.spline-container');

    containers.forEach(el => {
        const value = el.getAttribute('data-type');
        if (value) {
            el.addEventListener('mouseenter', () => {
                span.textContent = value;
            });
            el.addEventListener('mouseleave', () => {
                span.textContent = defaultText;
            });
        }
    });

    console.log('✅ Hover text enabled for', containers.length, 'spline containers');
});
</script>

<!-- WEBFLOW HTML STRUCTURE -->
<div class="spline-container" id="hero-container"></div>