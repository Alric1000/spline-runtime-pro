<!-- HERO SCENE - RUNTIME ACCESS VERSION -->
<!-- Direct access to Spline runtime internals -->

<script>
(function() {
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';
    const HERO_SCENE = 'hero-animation';
    const dpr = window.devicePixelRatio || 1;

    console.log('[HERO-4SKIS] Initializing with runtime access');

    let viewer = null;
    let splineApp = null;
    let isInteracting = false;
    let currentSki = null;
    let startX = 0;
    let startRotation = 0;
    let currentRotation = 0;
    let animationFrame = null;

    // Ski names - will be updated based on actual scene objects
    const SKI_NAMES = ['ALLMOUNTAIN', 'PARK', 'CARVE', 'POWDER'];
    const originalRotations = [0, 0, 0, 0];

    // Wait for spline-viewer
    function waitForSplineViewer() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (customElements.get('spline-viewer')) {
                    clearInterval(check);
                    resolve();
                }
            }, 50);
        });
    }

    // Create the hero viewer
    function createHeroViewer(container) {
        viewer = document.createElement('spline-viewer');
        viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${HERO_SCENE}/scene.splinecode`);
        viewer.setAttribute('id', 'hero-viewer');
        viewer.style.width = '100%';
        viewer.style.height = '100%';
        viewer.style.display = 'block';

        // Try to expose runtime
        viewer.setAttribute('loading-anim', 'false');
        viewer.setAttribute('mouse-controls', 'false');

        container.appendChild(viewer);

        // Multiple approaches to detect when ready
        viewer.addEventListener('load', onSceneLoad);
        viewer.addEventListener('ready', onSceneLoad);
        viewer.addEventListener('scene-ready', onSceneLoad);

        // Also check periodically
        let checkCount = 0;
        const checkInterval = setInterval(() => {
            checkCount++;
            if (findSplineApp() || checkCount > 20) {
                clearInterval(checkInterval);
                if (splineApp) {
                    onSceneReady();
                }
            }
        }, 500);

        return viewer;
    }

    // Scene loaded handler
    function onSceneLoad() {
        console.log('[HERO-4SKIS] Scene load event fired');
        setTimeout(() => {
            findSplineApp();
            if (splineApp) {
                onSceneReady();
            }
        }, 1000);
    }

    // Scene ready handler
    function onSceneReady() {
        console.log('[HERO-4SKIS] Scene ready');
        fixQuality(viewer);
        setupInteraction();
        discoverObjects();
    }

    // Find Spline app through various methods
    function findSplineApp() {
        // Method 1: Through shadow DOM
        if (viewer.shadowRoot) {
            const canvas = viewer.shadowRoot.querySelector('canvas');
            if (canvas) {
                // Check for app on canvas
                if (canvas._splineApp) {
                    splineApp = canvas._splineApp;
                    console.log('[HERO-4SKIS] Found app on canvas');
                    return true;
                }

                // Check for runtime on canvas
                if (canvas._runtime) {
                    splineApp = canvas._runtime;
                    console.log('[HERO-4SKIS] Found runtime on canvas');
                    return true;
                }
            }

            // Check for app on shadow root
            if (viewer.shadowRoot._splineApp) {
                splineApp = viewer.shadowRoot._splineApp;
                console.log('[HERO-4SKIS] Found app on shadow root');
                return true;
            }
        }

        // Method 2: Direct viewer properties
        const props = [
            '_runtime',
            '_application',
            '_app',
            'runtime',
            'application',
            'app',
            'spline',
            '_spline',
            'splineRuntime',
            '_splineRuntime'
        ];

        for (const prop of props) {
            if (viewer[prop]) {
                splineApp = viewer[prop];
                console.log(`[HERO-4SKIS] Found app as viewer.${prop}`);
                return true;
            }
        }

        // Method 3: Through viewer methods
        if (viewer.getSplineRuntime) {
            splineApp = viewer.getSplineRuntime();
            if (splineApp) {
                console.log('[HERO-4SKIS] Found app via getSplineRuntime()');
                return true;
            }
        }

        // Method 4: Emit event to get runtime
        if (viewer.emitEvent) {
            viewer.emitEvent('get-runtime', (runtime) => {
                splineApp = runtime;
                console.log('[HERO-4SKIS] Found app via event');
            });
        }

        // Method 5: Check window/global scope
        if (window.SPLINE && window.SPLINE.runtime) {
            splineApp = window.SPLINE.runtime;
            console.log('[HERO-4SKIS] Found app in window.SPLINE');
            return true;
        }

        return false;
    }

    // Discover actual object names in the scene
    function discoverObjects() {
        if (!splineApp) {
            console.log('[HERO-4SKIS] No app for object discovery');
            return;
        }

        console.log('[HERO-4SKIS] Discovering objects...');

        // Try different methods to get objects
        let objects = [];

        // Method 1: getAllObjects
        if (splineApp.getAllObjects) {
            objects = splineApp.getAllObjects();
            console.log('[HERO-4SKIS] Objects from getAllObjects:', objects.map(o => o.name));
        }

        // Method 2: scene.children
        if (!objects.length && splineApp.scene && splineApp.scene.children) {
            objects = splineApp.scene.children;
            console.log('[HERO-4SKIS] Objects from scene.children:', objects.map(o => o.name));
        }

        // Method 3: _scene
        if (!objects.length && splineApp._scene && splineApp._scene.children) {
            objects = splineApp._scene.children;
            console.log('[HERO-4SKIS] Objects from _scene.children:', objects.map(o => o.name));
        }

        // Update SKI_NAMES if we find ski objects
        const skiObjects = objects.filter(o =>
            o.name && (
                o.name.includes('SKI') ||
                o.name.includes('MOUNTAIN') ||
                o.name.includes('PARK') ||
                o.name.includes('CARVE') ||
                o.name.includes('POWDER')
            )
        );

        if (skiObjects.length > 0) {
            console.log('[HERO-4SKIS] Found ski objects:', skiObjects.map(o => o.name));
        }
    }

    // Fix quality
    function fixQuality(viewer) {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            console.log('[HERO-4SKIS] Quality fixed');
        }
    }

    // Setup interaction
    function setupInteraction() {
        let canvas = viewer.shadowRoot?.querySelector('canvas');
        if (!canvas) {
            canvas = viewer.querySelector('canvas');
        }

        if (!canvas) {
            console.warn('[HERO-4SKIS] Canvas not found');
            return;
        }

        // Force styles
        canvas.setAttribute('style',
            'width: 100% !important;' +
            'height: 100% !important;' +
            'touch-action: none !important;' +
            'user-select: none !important;' +
            '-webkit-user-select: none !important;' +
            'pointer-events: auto !important;' +
            'cursor: grab !important;'
        );

        // Events
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mouseleave', handleEnd);

        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd, { passive: false });
        canvas.addEventListener('touchcancel', handleEnd, { passive: false });

        console.log('[HERO-4SKIS] Interaction ready');
    }

    // Get ski zone from position
    function getSkiFromPosition(x, canvasWidth) {
        const zone = Math.floor((x / canvasWidth) * 4);
        return Math.min(Math.max(zone, 0), 3);
    }

    // Start interaction
    function handleStart(e) {
        e.preventDefault();

        const canvas = e.target;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const x = clientX - rect.left;

        currentSki = getSkiFromPosition(x, rect.width);
        isInteracting = true;
        startX = clientX;
        startRotation = currentRotation;

        canvas.style.cursor = 'grabbing';
        console.log(`[HERO-4SKIS] Interacting with ski ${currentSki}`);
    }

    // Move during interaction
    function handleMove(e) {
        if (!isInteracting || currentSki === null) return;

        e.preventDefault();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const deltaX = clientX - startX;
        const rotation = startRotation + (deltaX * 0.5);

        applyRotation(currentSki, rotation);
        currentRotation = rotation;
    }

    // End interaction
    function handleEnd(e) {
        if (!isInteracting) return;

        e.preventDefault();
        isInteracting = false;

        if (currentSki !== null) {
            animateBackToOriginal(currentSki);
        }

        const canvas = e.target;
        if (canvas) canvas.style.cursor = 'grab';

        currentSki = null;
    }

    // Apply rotation using emitEvent or direct access
    function applyRotation(skiIndex, rotation) {
        const skiName = SKI_NAMES[skiIndex];

        // Try emit event first (Spline's preferred method)
        if (viewer.emitEvent) {
            viewer.emitEvent('rotate', {
                name: skiName,
                rotation: rotation
            });
            console.log(`[HERO-4SKIS] Emitted rotate event for ${skiName}`);
            return;
        }

        // Fallback to direct manipulation
        if (!splineApp) {
            console.warn('[HERO-4SKIS] No Spline app for rotation');
            return;
        }

        try {
            let skiObject = null;

            // Try to find object
            if (splineApp.findObjectByName) {
                skiObject = splineApp.findObjectByName(skiName);
            } else if (splineApp.scene) {
                const searchScene = (obj, name) => {
                    if (obj.name === name) return obj;
                    if (obj.children) {
                        for (const child of obj.children) {
                            const found = searchScene(child, name);
                            if (found) return found;
                        }
                    }
                    return null;
                };
                skiObject = searchScene(splineApp.scene, skiName);
            }

            if (skiObject) {
                if (skiObject.rotation) {
                    skiObject.rotation.y = rotation * (Math.PI / 180);
                }
                console.log(`[HERO-4SKIS] Rotated ${skiName} to ${rotation.toFixed(1)}°`);
            }
        } catch (error) {
            console.warn('[HERO-4SKIS] Rotation error:', error);
        }
    }

    // Animate back
    function animateBackToOriginal(skiIndex) {
        const startRot = currentRotation;
        const endRot = originalRotations[skiIndex];
        const duration = 500;
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            const rotation = startRot + (endRot - startRot) * eased;

            applyRotation(skiIndex, rotation);

            if (progress < 1) {
                animationFrame = requestAnimationFrame(animate);
            } else {
                currentRotation = endRot;
            }
        }

        if (animationFrame) cancelAnimationFrame(animationFrame);
        animate();
    }

    // Initialize
    async function initialize() {
        await waitForSplineViewer();

        let container = document.querySelector('.spline-container') ||
                       document.querySelector('.hero-container') ||
                       document.getElementById('hero-container');

        if (!container) {
            console.error('[HERO-4SKIS] No container found');
            return;
        }

        console.log('[HERO-4SKIS] Found container:', container.className || container.id);
        createHeroViewer(container);
    }

    // Start
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        setTimeout(initialize, 100);
    }

    // Debug commands
    window.hero4Skis = {
        status: () => {
            console.log('[HERO-4SKIS] Status:');
            console.log('- Viewer:', !!viewer);
            console.log('- App:', !!splineApp);
            console.log('- App type:', splineApp ? splineApp.constructor.name : 'none');
        },

        findApp: () => {
            findSplineApp();
            console.log('[HERO-4SKIS] App found:', !!splineApp);
        },

        findObjects: () => {
            discoverObjects();
        },

        inspectViewer: () => {
            if (viewer) {
                console.log('[HERO-4SKIS] Viewer properties:');
                const props = Object.getOwnPropertyNames(viewer);
                const interesting = props.filter(p =>
                    p.includes('spline') ||
                    p.includes('runtime') ||
                    p.includes('app') ||
                    p.includes('scene') ||
                    p.startsWith('_')
                );
                console.log(interesting);

                // Check shadow DOM
                if (viewer.shadowRoot) {
                    const canvas = viewer.shadowRoot.querySelector('canvas');
                    if (canvas) {
                        console.log('[HERO-4SKIS] Canvas properties:');
                        const canvasProps = Object.getOwnPropertyNames(canvas);
                        const canvasInteresting = canvasProps.filter(p =>
                            p.includes('spline') ||
                            p.includes('runtime') ||
                            p.startsWith('_')
                        );
                        console.log(canvasInteresting);
                    }
                }
            }
        },

        testEmit: () => {
            if (viewer.emitEvent) {
                console.log('[HERO-4SKIS] Testing emitEvent...');
                viewer.emitEvent('test', { message: 'Hello Spline' });
            } else {
                console.log('[HERO-4SKIS] No emitEvent method');
            }
        }
    };

    console.log('[HERO-4SKIS] Commands: hero4Skis.status(), hero4Skis.inspectViewer(), hero4Skis.findObjects()');
})();
</script>

<!-- PAGE CODE -->
<style>
  .spline-container { position: relative; }
</style>

<!-- WEBFLOW HTML -->
<div class="spline-container" id="hero-container"></div>