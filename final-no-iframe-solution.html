<!-- FINAL SOLUTION: Direct spline-viewer elements (NO IFRAMES, GOOD FOR SEO) -->

<style>
  /* Spline viewer styling */
  spline-viewer {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Keep your existing styles */
  .type-trigger spline-viewer,
  .ski_container spline-viewer {
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }
</style>

<!-- Load Spline Viewer ONCE (in page head or before first scene) -->
<script type="module" src="https://unpkg.com/@splinetool/viewer@1.10.57/build/spline-viewer.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Your Cloudflare CDN (FAST!)
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';

    // Performance tracking
    console.time('Spline Setup');

    // Convert existing canvases to spline-viewer elements
    function upgradeCanvases() {
        const canvases = document.querySelectorAll('[data-spline-scene]');

        canvases.forEach(canvas => {
            const scenePath = canvas.getAttribute('data-spline-scene');

            // Create spline-viewer element (NOT an iframe!)
            const viewer = document.createElement('spline-viewer');

            // Use YOUR Cloudflare-hosted scenes (faster than Spline's CDN)
            viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${scenePath}/scene.splinecode`);
            viewer.setAttribute('id', canvas.id);

            // Keep all classes and attributes
            viewer.className = canvas.className;
            Array.from(canvas.attributes).forEach(attr => {
                if (attr.name.startsWith('data-')) {
                    viewer.setAttribute(attr.name, attr.value);
                }
            });

            // Replace canvas with viewer
            canvas.replaceWith(viewer);
        });

        console.log(`✅ Upgraded ${canvases.length} scenes to use Spline viewer`);
    }

    // Lazy loading (keeps your optimization)
    function setupLazyLoading() {
        const viewers = document.querySelectorAll('spline-viewer');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const maxActive = isMobile ? 2 : 4;
        let activeCount = 0;

        viewers.forEach(viewer => {
            let loaded = false;

            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !loaded && activeCount < maxActive) {
                    // Viewer loads the scene automatically when visible
                    loaded = true;
                    activeCount++;
                    console.log(`Loading scene ${activeCount}/${maxActive}`);
                }
            }, {
                rootMargin: '100px',
                threshold: 0.1
            });

            observer.observe(viewer);
        });
    }

    // Run setup
    upgradeCanvases();
    setupLazyLoading();

    console.timeEnd('Spline Setup');

    // Test function
    window.testSplinePerformance = async () => {
        const results = {
            cloudflareSpeed: 0,
            splineSpeed: 0
        };

        // Test Cloudflare speed
        const cf1 = performance.now();
        await fetch(`${CLOUDFLARE_URL}/scenes/1000SKISALLMOUNTAIN/scene.splinecode`, {method: 'HEAD'});
        results.cloudflareSpeed = performance.now() - cf1;

        // Test Spline CDN speed
        const sp1 = performance.now();
        await fetch('https://prod.spline.design/9dOa33ipKEZ2BEHQ/scene.splinecode', {method: 'HEAD'});
        results.splineSpeed = performance.now() - sp1;

        console.table(results);
        console.log(`Cloudflare is ${(results.splineSpeed / results.cloudflareSpeed).toFixed(1)}x faster`);

        return results;
    };
});
</script>

<!-- In your HTML, keep your existing structure -->
<!-- The script will automatically convert these to spline-viewer elements -->
<div class="type-trigger" data-type="All Mountain">
    <canvas id="allmountain-showcase" data-spline-scene="1000SKISALLMOUNTAIN"></canvas>
</div>

<div class="type-trigger" data-type="Park">
    <canvas id="park-showcase" data-spline-scene="1000SKISPARK"></canvas>
</div>

<!-- etc... -->

<!--
SUMMARY:
✅ NO iframes (good for SEO)
✅ Spline viewer loads ONCE (cached for all scenes)
✅ Scenes load from YOUR Cloudflare (faster)
✅ Perfect high-DPI rendering (Spline's viewer handles it)
✅ Keeps your lazy loading optimization
✅ Direct DOM elements (search engines can see them)
-->