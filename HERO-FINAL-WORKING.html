<!-- HERO SCENE - FINAL WORKING VERSION -->
<!-- Uses correct object names from your scene -->

<script>
(function() {
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';
    const HERO_SCENE = 'hero-animation';
    const dpr = window.devicePixelRatio || 1;

    console.log('[HERO-4SKIS] Final version - starting');

    let viewer = null;
    let splineApp = null;
    let isInteracting = false;
    let currentSki = null;
    let startX = 0;
    let currentRotations = [0, 0, 0, 0];
    let animationFrame = null;

    // ACTUAL object names from your scene
    const SKI_NAMES = [
        'normalmap test 4 bake test 300x4000 MCP',      // Ski 1 (leftmost)
        'normalmap test 4 bake test 300x4000 MCP 4',    // Ski 2
        'normalmap test 4 bake test 300x4000 MCP 3',    // Ski 3
        'normalmap test 4 bake test 300x4000 MCP 2'     // Ski 4 (rightmost)
    ];

    // Wait for spline-viewer element
    function waitForSplineViewer() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (customElements.get('spline-viewer')) {
                    clearInterval(check);
                    resolve();
                }
            }, 50);
        });
    }

    // Create viewer
    function createHeroViewer(container) {
        viewer = document.createElement('spline-viewer');
        viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${HERO_SCENE}/scene.splinecode`);
        viewer.setAttribute('id', 'hero-viewer');
        viewer.style.width = '100%';
        viewer.style.height = '100%';
        viewer.style.display = 'block';

        container.appendChild(viewer);

        // Wait for scene load
        viewer.addEventListener('load', () => {
            console.log('[HERO-4SKIS] Scene loaded');
            setTimeout(() => {
                initializeScene();
            }, 1000);
        });

        return viewer;
    }

    // Initialize scene
    function initializeScene() {
        // Get Spline app reference
        splineApp = viewer._spline;

        if (splineApp) {
            console.log('[HERO-4SKIS] Spline app found');

            // Verify objects exist
            if (splineApp.getAllObjects) {
                const objects = splineApp.getAllObjects();
                console.log('[HERO-4SKIS] Found objects:', objects.length);

                // Find ski objects
                const skiObjects = SKI_NAMES.map(name => {
                    const obj = splineApp.findObjectByName(name);
                    if (obj) {
                        console.log(`[HERO-4SKIS] Found ski: ${name}`);
                    }
                    return obj;
                });
            }

            fixQuality();
            setupInteraction();
        } else {
            console.warn('[HERO-4SKIS] Spline app not found, retrying...');
            setTimeout(initializeScene, 500);
        }
    }

    // Fix rendering quality
    function fixQuality() {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            console.log('[HERO-4SKIS] Quality fixed');
        }
    }

    // Setup mouse/touch interaction
    function setupInteraction() {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (!canvas) {
            console.warn('[HERO-4SKIS] Canvas not found');
            return;
        }

        // Force interaction styles
        canvas.style.touchAction = 'none';
        canvas.style.userSelect = 'none';
        canvas.style.webkitUserSelect = 'none';
        canvas.style.pointerEvents = 'auto';
        canvas.style.cursor = 'grab';

        // Mouse events
        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove); // Use window for smoother tracking
        window.addEventListener('mouseup', handleEnd);

        // Touch events
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd, { passive: false });

        console.log('[HERO-4SKIS] Interaction ready');
    }

    // Determine which ski from X position
    function getSkiFromPosition(x, canvasWidth) {
        const zone = Math.floor((x / canvasWidth) * 4);
        return Math.min(Math.max(zone, 0), 3);
    }

    // Start interaction
    function handleStart(e) {
        if (!splineApp) return;

        e.preventDefault();

        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const x = clientX - rect.left;

        currentSki = getSkiFromPosition(x, rect.width);
        isInteracting = true;
        startX = clientX;

        canvas.style.cursor = 'grabbing';
        console.log(`[HERO-4SKIS] Starting rotation of ski ${currentSki + 1}`);
    }

    // Handle movement
    function handleMove(e) {
        if (!isInteracting || currentSki === null || !splineApp) return;

        e.preventDefault();

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const deltaX = clientX - startX;

        // Calculate rotation (0.5 = sensitivity)
        const rotation = deltaX * 0.5;
        currentRotations[currentSki] = rotation;

        applyRotation(currentSki, rotation);
    }

    // End interaction
    function handleEnd(e) {
        if (!isInteracting) return;

        e.preventDefault();
        isInteracting = false;

        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');
        if (canvas) {
            canvas.style.cursor = 'grab';
        }

        // Animate back to original position
        if (currentSki !== null) {
            animateBackToOriginal(currentSki);
        }

        currentSki = null;
    }

    // Apply rotation to ski
    function applyRotation(skiIndex, degrees) {
        if (!splineApp) return;

        const skiName = SKI_NAMES[skiIndex];
        const skiObject = splineApp.findObjectByName(skiName);

        if (skiObject) {
            // Convert degrees to radians for THREE.js
            const radians = degrees * (Math.PI / 180);

            // Apply Y-axis rotation
            if (skiObject.rotation) {
                skiObject.rotation.y = radians;
            } else if (skiObject.transform && skiObject.transform.rotation) {
                skiObject.transform.rotation.y = radians;
            }

            // Force render update
            if (splineApp.renderer && splineApp.renderer.render) {
                splineApp.renderer.render(splineApp.scene, splineApp.camera);
            }

            console.log(`[HERO-4SKIS] Rotated ski ${skiIndex + 1} to ${degrees.toFixed(1)}°`);
        } else {
            console.warn(`[HERO-4SKIS] Could not find ski object: ${skiName}`);
        }
    }

    // Animate back to original rotation
    function animateBackToOriginal(skiIndex) {
        const startRotation = currentRotations[skiIndex];
        const endRotation = 0;
        const duration = 500;
        const startTime = Date.now();

        function animate() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Easing function (ease-out-cubic)
            const eased = 1 - Math.pow(1 - progress, 3);

            // Calculate current rotation
            const rotation = startRotation + (endRotation - startRotation) * eased;
            currentRotations[skiIndex] = rotation;

            applyRotation(skiIndex, rotation);

            if (progress < 1) {
                animationFrame = requestAnimationFrame(animate);
            }
        }

        if (animationFrame) {
            cancelAnimationFrame(animationFrame);
        }

        animate();
    }

    // Initialize everything
    async function initialize() {
        await waitForSplineViewer();

        // Find container
        const container = document.querySelector('.spline-container') ||
                         document.querySelector('.hero-container') ||
                         document.getElementById('hero-container');

        if (!container) {
            console.error('[HERO-4SKIS] No container found');
            return;
        }

        console.log('[HERO-4SKIS] Container found:', container.className || container.id);
        createHeroViewer(container);
    }

    // Start when DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        setTimeout(initialize, 100);
    }

    // Global debug/test commands
    window.hero4Skis = {
        // Check status
        status: () => {
            console.log('[HERO-4SKIS] Status:');
            console.log('- Viewer ready:', !!viewer);
            console.log('- Spline app ready:', !!splineApp);
            console.log('- Ski objects:', SKI_NAMES);
        },

        // Test rotation
        testRotation: (skiIndex, degrees) => {
            if (skiIndex >= 0 && skiIndex < 4) {
                console.log(`[HERO-4SKIS] Testing ski ${skiIndex + 1} at ${degrees}°`);
                applyRotation(skiIndex, degrees);
                setTimeout(() => {
                    animateBackToOriginal(skiIndex);
                }, 1000);
            } else {
                console.log('[HERO-4SKIS] Use index 0-3 for skis');
            }
        },

        // List objects
        listObjects: () => {
            if (splineApp && splineApp.getAllObjects) {
                const objects = splineApp.getAllObjects();
                console.log('[HERO-4SKIS] Scene objects:');
                objects.forEach((obj, i) => {
                    console.log(`${i}: ${obj.name}`);
                });
            } else {
                console.log('[HERO-4SKIS] Spline app not ready');
            }
        },

        // Get specific ski object
        getSki: (index) => {
            if (splineApp) {
                const skiName = SKI_NAMES[index];
                const ski = splineApp.findObjectByName(skiName);
                console.log(`[HERO-4SKIS] Ski ${index + 1}:`, ski);
                return ski;
            }
        }
    };

    console.log('[HERO-4SKIS] Ready! Commands: hero4Skis.status(), hero4Skis.testRotation(0-3, degrees)');
})();
</script>

<!-- PAGE STYLES -->
<style>
  .spline-container {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .spline-container *,
  spline-viewer {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
</style>

<!-- Hover text script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const span = document.getElementById('typeSpan');
    if (!span) return;

    const defaultText = span.textContent;
    const containers = document.querySelectorAll('.spline-container');

    containers.forEach(el => {
        const value = el.getAttribute('data-type');
        if (value) {
            el.addEventListener('mouseenter', () => {
                span.textContent = value;
            });
            el.addEventListener('mouseleave', () => {
                span.textContent = defaultText;
            });
        }
    });

    console.log('✅ Hover text enabled for', containers.length, 'spline containers');
});
</script>

<!-- WEBFLOW HTML -->
<div class="spline-container" id="hero-container"></div>