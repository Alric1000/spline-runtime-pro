<!-- FULLY SELF-HOSTED SOLUTION: Everything from your Cloudflare! -->

<style>
  /* Spline viewer styling */
  spline-viewer {
    width: 100%;
    height: 100%;
    display: block;
  }

  .type-trigger spline-viewer,
  .ski_container spline-viewer {
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }
</style>

<!-- Load Spline Viewer from YOUR Cloudflare (not unpkg!) -->
<script type="module" src="https://spline-runtime-pro.pages.dev/spline-viewer.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Everything from YOUR CDN!
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';

    console.log('ðŸš€ Loading Spline viewer from YOUR Cloudflare CDN');

    // Convert canvases to spline-viewer elements
    function initializeSplineScenes() {
        const canvases = document.querySelectorAll('[data-spline-scene]');

        canvases.forEach(canvas => {
            const scenePath = canvas.getAttribute('data-spline-scene');

            // Create spline-viewer element
            const viewer = document.createElement('spline-viewer');

            // BOTH viewer AND scenes from your CDN!
            viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${scenePath}/scene.splinecode`);
            viewer.setAttribute('id', canvas.id);
            viewer.className = canvas.className;

            // Copy data attributes
            Array.from(canvas.attributes).forEach(attr => {
                if (attr.name.startsWith('data-')) {
                    viewer.setAttribute(attr.name, attr.value);
                }
            });

            // Replace canvas with viewer
            canvas.replaceWith(viewer);

            console.log(`âœ… Scene ${scenePath} configured (fully self-hosted)`);
        });

        return canvases.length;
    }

    // Lazy loading for performance
    function setupLazyLoading() {
        const viewers = document.querySelectorAll('spline-viewer');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const maxActive = isMobile ? 2 : 4;
        let activeCount = 0;
        const loadQueue = [];

        viewers.forEach(viewer => {
            let isLoaded = false;

            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    if (!isLoaded) {
                        if (activeCount < maxActive) {
                            isLoaded = true;
                            activeCount++;
                            viewer.style.visibility = 'visible';
                            console.log(`Loading scene ${activeCount}/${maxActive}`);
                        } else {
                            loadQueue.push(viewer);
                        }
                    }
                } else if (isLoaded) {
                    // Scene left viewport
                    activeCount--;

                    // Load next in queue if any
                    if (loadQueue.length > 0 && activeCount < maxActive) {
                        const next = loadQueue.shift();
                        next.style.visibility = 'visible';
                        activeCount++;
                    }
                }
            }, {
                rootMargin: '100px',
                threshold: 0.1
            });

            observer.observe(viewer);
        });

        console.log(`ðŸ“Š Lazy loading configured: ${viewers.length} scenes (max ${maxActive} concurrent)`);
    }

    // Initialize everything
    const sceneCount = initializeSplineScenes();

    // Wait a bit for custom element to register
    setTimeout(() => {
        setupLazyLoading();
        console.log(`âœ¨ Fully self-hosted Spline setup complete!`);
        console.log(`ðŸ“¦ All assets loading from: ${CLOUDFLARE_URL}`);
    }, 100);

    // Performance monitoring
    window.splinePerformance = {
        checkLoading: () => {
            const viewers = document.querySelectorAll('spline-viewer');
            viewers.forEach(v => {
                console.log(`${v.id}: ${v.style.visibility || 'hidden'}`);
            });
        },

        compareSpeed: async () => {
            console.log('Testing CDN speeds...');

            // Test your CDN
            const t1 = performance.now();
            await fetch(`${CLOUDFLARE_URL}/spline-viewer.js`, {method: 'HEAD'});
            const yourCDN = performance.now() - t1;

            // Test unpkg
            const t2 = performance.now();
            await fetch('https://unpkg.com/@splinetool/viewer@1.10.57/build/spline-viewer.js', {method: 'HEAD'});
            const unpkg = performance.now() - t2;

            console.table({
                'Your Cloudflare': yourCDN.toFixed(0) + 'ms',
                'Unpkg CDN': unpkg.toFixed(0) + 'ms',
                'Speed advantage': ((unpkg/yourCDN).toFixed(1) + 'x faster')
            });
        }
    };
});
</script>

<!-- Your HTML structure stays the same -->
<div class="type-trigger" data-type="All Mountain">
    <canvas id="allmountain-showcase" data-spline-scene="1000SKISALLMOUNTAIN"></canvas>
</div>

<!--
BENEFITS OF FULLY SELF-HOSTED:
âœ… Spline viewer loads from YOUR Cloudflare (faster)
âœ… Scene files load from YOUR Cloudflare (already doing this)
âœ… Single CDN = better caching, fewer DNS lookups
âœ… You control everything (versioning, caching rules)
âœ… Perfect high-DPI rendering (using Spline's viewer)
âœ… ~623KB gzipped (Cloudflare does this automatically)

PERFORMANCE:
- First load: ~623KB viewer + scene files
- Subsequent pages: Viewer cached, only load new scenes
- All from YOUR fast Cloudflare CDN
-->