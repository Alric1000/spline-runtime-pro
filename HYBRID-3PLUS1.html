<!-- HYBRID SOLUTION: 3 Live + 1 Static/Interactive -->
<!-- Shows 3 live 3D scenes + 1 static that becomes live on hover -->

<script async src="https://cdn.jsdelivr.net/npm/@finsweet/cookie-consent@1/fs-cc.js" fs-cc-mode="opt-in"></script>

<script>
(function() {
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';
    const dpr = window.devicePixelRatio || 1;
    const MAX_LIVE_SCENES = 3;

    console.log('[HYBRID-3+1] Initializing hybrid system');

    let containers = [];
    let viewers = new Map(); // container -> viewer
    let liveViewers = new Set();
    let staticContainers = new Set();

    // Wait for spline-viewer custom element
    function waitForSplineViewer() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (customElements.get('spline-viewer')) {
                    clearInterval(check);
                    resolve();
                }
            }, 50);
        });
    }

    // Create placeholder for static scenes
    function createPlaceholder(container) {
        const placeholder = document.createElement('div');
        placeholder.className = 'spline-placeholder';
        placeholder.innerHTML = `
            <div style="
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                font-family: system-ui, -apple-system, sans-serif;
                cursor: pointer;
                position: relative;
                overflow: hidden;
            ">
                <div style="text-align: center; z-index: 1;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ðŸŽ¿</div>
                    <div style="font-size: 14px; opacity: 0.9;">Click to view 3D</div>
                </div>
                <div style="
                    position: absolute;
                    top: -50%;
                    left: -50%;
                    width: 200%;
                    height: 200%;
                    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                    animation: pulse 3s ease-in-out infinite;
                "></div>
            </div>
        `;

        // Add click handler to activate
        placeholder.onclick = () => activateContainer(container);

        container.appendChild(placeholder);
        staticContainers.add(container);

        return placeholder;
    }

    // Create viewer for container
    function createViewer(container) {
        const sceneName = container.dataset.scene;
        if (!sceneName) return null;

        const viewer = document.createElement('spline-viewer');
        viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${sceneName}/scene.splinecode`);
        viewer.setAttribute('id', (container.id || 'viewer') + '-3d');
        viewer.style.width = '100%';
        viewer.style.height = '100%';
        viewer.style.display = 'block';

        container.appendChild(viewer);

        // Apply quality fix
        setTimeout(() => fixQuality(viewer), 100);
        setTimeout(() => fixQuality(viewer), 500);
        setTimeout(() => fixQuality(viewer), 1000);

        return viewer;
    }

    // Fix quality for viewer
    function fixQuality(viewer) {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            if (width > 0 && height > 0) {
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';

                // Fix renderer
                const paths = [
                    () => viewer._scene?._renderer,
                    () => viewer._application?._renderer,
                    () => viewer.renderer
                ];

                for (const getPath of paths) {
                    try {
                        const renderer = getPath();
                        if (renderer?.setPixelRatio) {
                            renderer.setPixelRatio(dpr);
                            renderer.setSize(width, height, false);
                            break;
                        }
                    } catch (e) {}
                }
            }
        }
    }

    // Activate a container (make it live)
    function activateContainer(container) {
        // Check if already live
        if (viewers.has(container) && liveViewers.has(viewers.get(container))) {
            return;
        }

        // Check if we need to deactivate one
        if (liveViewers.size >= MAX_LIVE_SCENES) {
            // Find the least important live viewer to deactivate
            const toDeactivate = Array.from(liveViewers)[0];
            deactivateViewer(toDeactivate);
        }

        // Remove placeholder if exists
        const placeholder = container.querySelector('.spline-placeholder');
        if (placeholder) {
            placeholder.remove();
            staticContainers.delete(container);
        }

        // Create or show viewer
        let viewer = viewers.get(container);
        if (!viewer) {
            viewer = createViewer(container);
            viewers.set(container, viewer);
        } else {
            viewer.style.display = 'block';
        }

        liveViewers.add(viewer);
        console.log(`[HYBRID-3+1] Activated viewer (${liveViewers.size}/${MAX_LIVE_SCENES} live)`);
    }

    // Deactivate a viewer (make it static)
    function deactivateViewer(viewer) {
        if (!liveViewers.has(viewer)) return;

        // Find container
        let container = null;
        for (const [c, v] of viewers) {
            if (v === viewer) {
                container = c;
                break;
            }
        }

        if (container) {
            viewer.style.display = 'none';
            createPlaceholder(container);
        }

        liveViewers.delete(viewer);
        console.log(`[HYBRID-3+1] Deactivated viewer (${liveViewers.size}/${MAX_LIVE_SCENES} live)`);
    }

    // Initialize system
    async function initialize() {
        await waitForSplineViewer();

        // Add CSS for animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 0.3; }
                50% { transform: scale(1.1); opacity: 0.5; }
            }
            .spline-placeholder {
                width: 100%;
                height: 100%;
            }
        `;
        document.head.appendChild(style);

        // Find all containers
        containers = Array.from(document.querySelectorAll('.spline-container'));
        console.log(`[HYBRID-3+1] Found ${containers.length} containers`);

        // Activate first 3, make 4th static
        containers.forEach((container, index) => {
            if (index < MAX_LIVE_SCENES) {
                activateContainer(container);
            } else {
                createPlaceholder(container);
            }
        });

        // Add hover activation for better UX
        containers.forEach(container => {
            container.addEventListener('mouseenter', () => {
                if (staticContainers.has(container)) {
                    // Show preview on hover
                    const placeholder = container.querySelector('.spline-placeholder');
                    if (placeholder) {
                        placeholder.style.transform = 'scale(1.05)';
                    }
                }
            });

            container.addEventListener('mouseleave', () => {
                const placeholder = container.querySelector('.spline-placeholder');
                if (placeholder) {
                    placeholder.style.transform = 'scale(1)';
                }
            });
        });
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        setTimeout(initialize, 100);
    }

    // Manual controls
    window.hybrid3Plus1 = {
        status: () => {
            console.log(`[HYBRID-3+1] Live: ${liveViewers.size}/${MAX_LIVE_SCENES}`);
            console.log(`[HYBRID-3+1] Static: ${staticContainers.size}`);
        },

        activateAll: () => {
            // This will still respect the limit
            containers.forEach(container => activateContainer(container));
        }
    };

    console.log('[HYBRID-3+1] Ready. Commands: hybrid3Plus1.status()');
})();
</script>