<!-- FINAL SCREENSHOT SOLUTION: Pre-captured images with 3D on demand -->
<!-- Screenshots are served from your Cloudflare CDN for instant loading -->

<script async src="https://cdn.jsdelivr.net/npm/@finsweet/cookie-consent@1/fs-cc.js" fs-cc-mode="opt-in"></script>

<script>
(function() {
    const CLOUDFLARE_URL = 'https://spline-runtime-pro.pages.dev';
    const dpr = window.devicePixelRatio || 1;
    const MAX_LIVE_SCENES = 3;

    // Pre-captured screenshot URLs (stored in your repo)
    const SCREENSHOT_URLS = {
        'allmountain-container': `${CLOUDFLARE_URL}/screenshots/allmountain-screenshot.png`,
        'park-container': `${CLOUDFLARE_URL}/screenshots/park-screenshot.png`,
        'carve-container': `${CLOUDFLARE_URL}/screenshots/carve-screenshot.png`,
        'powder-container': `${CLOUDFLARE_URL}/screenshots/powder-screenshot.png`
    };

    console.log('[SCREENSHOT-3D] Initializing screenshot-to-3D system');

    let containers = [];
    let liveViewers = new Map();
    let activeCount = 0;

    // Wait for spline-viewer
    function waitForSplineViewer() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (customElements.get('spline-viewer')) {
                    clearInterval(check);
                    resolve();
                }
            }, 50);
        });
    }

    // Create screenshot placeholder with instant loading
    function createScreenshotPlaceholder(container) {
        const screenshotUrl = SCREENSHOT_URLS[container.id];
        if (!screenshotUrl) {
            console.warn(`[SCREENSHOT-3D] No screenshot URL for ${container.id}`);
            return null;
        }

        const placeholder = document.createElement('div');
        placeholder.className = 'spline-screenshot';
        placeholder.style.cssText = `
            width: 100%;
            height: 100%;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-image: url(${screenshotUrl});
            transition: transform 0.3s ease;
        `;

        // Add interactive overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        `;

        const label = document.createElement('div');
        label.style.cssText = `
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-family: system-ui, -apple-system, sans-serif;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        `;
        label.textContent = 'ðŸŽ¿ View 3D';

        placeholder.appendChild(overlay);
        placeholder.appendChild(label);

        // Hover effects
        placeholder.addEventListener('mouseenter', () => {
            placeholder.style.transform = 'scale(1.02)';
            overlay.style.opacity = '1';
            label.style.opacity = '1';
            label.style.transform = 'translateY(0)';
        });

        placeholder.addEventListener('mouseleave', () => {
            placeholder.style.transform = 'scale(1)';
            overlay.style.opacity = '0';
            label.style.opacity = '0';
            label.style.transform = 'translateY(10px)';
        });

        // Click to activate 3D
        placeholder.addEventListener('click', () => {
            activateContainer(container);
        });

        container.appendChild(placeholder);
        return placeholder;
    }

    // Create 3D viewer
    function createViewer(container) {
        const sceneName = container.dataset.scene;
        if (!sceneName) return null;

        const viewer = document.createElement('spline-viewer');
        viewer.setAttribute('url', `${CLOUDFLARE_URL}/scenes/${sceneName}/scene.splinecode`);
        viewer.setAttribute('id', container.id + '-viewer');
        viewer.style.width = '100%';
        viewer.style.height = '100%';
        viewer.style.display = 'block';

        container.appendChild(viewer);

        // Fix quality
        setTimeout(() => fixQuality(viewer), 100);
        setTimeout(() => fixQuality(viewer), 500);
        setTimeout(() => fixQuality(viewer), 1000);

        return viewer;
    }

    // Fix quality for viewer
    function fixQuality(viewer) {
        const canvas = viewer.shadowRoot?.querySelector('canvas') ||
                      viewer.querySelector('canvas');

        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            if (width > 0 && height > 0) {
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';

                // Fix renderer
                const paths = [
                    () => viewer._scene?._renderer,
                    () => viewer._application?._renderer,
                    () => viewer.renderer
                ];

                for (const getPath of paths) {
                    try {
                        const renderer = getPath();
                        if (renderer?.setPixelRatio) {
                            renderer.setPixelRatio(dpr);
                            renderer.setSize(width, height, false);
                            break;
                        }
                    } catch (e) {}
                }
            }
        }
    }

    // Activate 3D view for container
    function activateContainer(container) {
        if (liveViewers.has(container)) return;

        // Check if we're at limit
        if (activeCount >= MAX_LIVE_SCENES) {
            // Find oldest to deactivate
            const [oldestContainer] = liveViewers.keys();
            deactivateContainer(oldestContainer);
        }

        // Remove screenshot
        const screenshot = container.querySelector('.spline-screenshot');
        if (screenshot) {
            // Fade out effect
            screenshot.style.opacity = '0';
            setTimeout(() => screenshot.remove(), 300);
        }

        // Create and show viewer
        const viewer = createViewer(container);
        liveViewers.set(container, viewer);
        activeCount++;

        console.log(`[SCREENSHOT-3D] Activated 3D for ${container.id} (${activeCount}/${MAX_LIVE_SCENES})`);
    }

    // Deactivate 3D view, show screenshot
    function deactivateContainer(container) {
        const viewer = liveViewers.get(container);
        if (!viewer) return;

        // Remove viewer
        viewer.remove();
        liveViewers.delete(container);
        activeCount--;

        // Add screenshot back
        createScreenshotPlaceholder(container);

        console.log(`[SCREENSHOT-3D] Deactivated 3D for ${container.id} (${activeCount}/${MAX_LIVE_SCENES})`);
    }

    // Initialize system
    async function initialize() {
        await waitForSplineViewer();

        // Find all containers
        containers = Array.from(document.querySelectorAll('.spline-container'));
        console.log(`[SCREENSHOT-3D] Found ${containers.length} containers`);

        // Add screenshots to all containers
        containers.forEach(container => {
            createScreenshotPlaceholder(container);
        });

        // Preload all screenshot images for instant display
        Object.values(SCREENSHOT_URLS).forEach(url => {
            const img = new Image();
            img.src = url;
        });

        console.log('[SCREENSHOT-3D] Ready - all scenes shown as screenshots');
        console.log('[SCREENSHOT-3D] Click any screenshot to view in 3D');
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        setTimeout(initialize, 100);
    }

    // Global controls
    window.screenshot3D = {
        status: () => {
            console.log(`[SCREENSHOT-3D] Active 3D: ${activeCount}/${MAX_LIVE_SCENES}`);
            console.log(`[SCREENSHOT-3D] Screenshot placeholders: ${containers.length - activeCount}`);
        },

        activateAll: () => {
            // Activate first 3 only (respects limit)
            containers.slice(0, MAX_LIVE_SCENES).forEach(activateContainer);
        },

        deactivateAll: () => {
            liveViewers.forEach((viewer, container) => {
                deactivateContainer(container);
            });
        }
    };

    console.log('[SCREENSHOT-3D] Commands: screenshot3D.status(), screenshot3D.activateAll()');
})();
</script>